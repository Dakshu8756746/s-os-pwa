<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>S-OS INFINITY / S-AURA SYSTEM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6.2.1/dist/umd.js"></script> <style>
        /* iOS 17 & Notion-like Dark Theme */
        :root { --bg: #000000; --card: #1c1c1e; --accent: #0A84FF; }
        body { 
            background: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; 
            padding-top: env(safe-area-inset-top); padding-bottom: calc(env(safe-area-inset-bottom) + 60px); 
            overflow: hidden;
        }
        .glass { background: rgba(28, 28, 30, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .ios-card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 12px; }
        .tab-active { color: var(--accent); }
        [x-cloak] { display: none !important; }
        .pwa-area { height: calc(100vh - 100px - env(safe-area-inset-bottom)); }
        /* Custom scrollbar for webkit (iPad) */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>

<body x-data="app()" x-init="initApp()" class="h-screen flex flex-col">

    <header class="glass fixed top-0 w-full z-50 px-4 h-16 flex items-center justify-between">
        <h1 class="text-2xl font-bold tracking-wider text-white">S-AURA</h1>
        <button @click="togglePause()" class="px-3 py-1 rounded font-bold text-xs transition-colors" :class="isPaused ? 'bg-red-700' : 'bg-green-700'">
            <span x-text="isPaused ? 'PAUSED' : 'APPLY (NYX)'"></span>
        </button>
    </header>

    <main class="flex-1 overflow-y-auto pt-20 pb-20 px-4 scroll-smooth pwa-area">
        
        <div x-show="view === 'dashboard'" x-cloak>
            <h2 class="text-3xl font-bold mb-4">Evolution Index: <span x-text="user.stats.evolution_index.toFixed(2)"></span></h2>
            
            <div class="ios-card grid grid-cols-2 gap-4">
                <div class="text-center">
                    <h3 class="text-xl font-bold" x-text="'Lvl ' + user.level"></h3>
                    <p class="text-sm text-gray-400">XP: <span x-text="user.xp"></span></p>
                </div>
                 <div class="text-center">
                    <h3 class="text-xl font-bold" x-text="todayKPIs.steps"></h3>
                    <p class="text-sm text-gray-400">Steps (Manual Input)</p>
                    <input type="number" x-model="todayKPIs.steps" @change="syncKPIs" class="w-20 bg-gray-700 text-xs rounded text-center mt-1">
                </div>
            </div>

            <div class="ios-card bg-gray-900 border-l-4" :class="currentBlock.is_locked ? 'border-red-500' : 'border-blue-500'">
                <h3 class="font-bold text-gray-300">CURRENT BLOCK (<span x-text="currentTime"></span>)</h3>
                <p class="text-xl" x-text="currentBlock.title"></p>
                <div x-show="currentBlock.is_locked" class="text-xs text-red-500 mt-1">LOCKED: Tuition (7:00-8:00 PM)</div>
            </div>

            <div class="ios-card"><canvas id="kpiChart"></canvas></div>
        </div>

        <div x-show="view === 'courses'" x-cloak>
            <h2 class="text-2xl font-bold mb-4">Knowledge Vault / Import</h2>
            <div class="ios-card">
                <input x-model="inputUrl" placeholder="Paste URL/Playlist ID" class="w-full bg-gray-800 rounded px-3 py-2 mb-2">
                <select x-model="scrapeType" class="w-full bg-gray-800 rounded px-3 py-2 mb-4">
                    <option value="web">Web Page (Headings)</option>
                    <option value="youtube_playlist">YouTube Playlist ID</option>
                </select>
                <button @click="importSyllabus()" class="w-full bg-blue-600 px-4 py-2 rounded font-bold">Import Syllabus</button>
            </div>

            <h3 class="text-xl font-bold mt-6 mb-2">My Courses</h3>
            <template x-for="c in courses" :key="c.id">
                <div class="ios-card border-l-4 border-yellow-500">
                    <h3 class="font-bold" x-text="c.title"></h3>
                    <div class="w-full bg-gray-700 h-1 mt-2 rounded">
                        <div class="bg-yellow-500 h-1 rounded" :style="`width: ${c.progress_percent}%`"></div>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="view === 'srs'" x-cloak>
            <h2 class="text-2xl font-bold mb-4">SRS Review: <span x-text="flashcardsToReview.length"></span> Cards Due</h2>
            <div x-show="currentCard" class="ios-card flex flex-col items-center min-h-40">
                <h3 class="text-xl font-bold mb-4" x-text="currentCard.front"></h3>
                <div x-show="cardRevealed" class="text-lg text-gray-300 mb-6" x-text="currentCard.back"></div>
                <button @click="cardRevealed = true" x-show="!cardRevealed" class="bg-gray-700 py-2 px-6 rounded mb-4">Reveal Answer</button>

                <div x-show="cardRevealed" class="flex gap-3">
                    <button @click="updateSRS(0)" class="bg-red-700 py-2 px-4 rounded text-sm">Forgot (Box 1)</button>
                    <button @click="updateSRS(3)" class="bg-yellow-700 py-2 px-4 rounded text-sm">Hard (Box 3)</button>
                    <button @click="updateSRS(5)" class="bg-green-700 py-2 px-4 rounded text-sm">Perfect (Box 5)</button>
                </div>
            </div>
            <div x-show="!currentCard" class="ios-card text-center text-gray-500">No cards due for review.</div>
        </div>

        <div x-show="view === 'nyx'" x-cloak class="h-full flex flex-col">
            <h2 class="text-2xl font-bold mb-4">NYX Console & Audit Log</h2>
            <div class="ios-card bg-gray-900 flex-1 overflow-y-auto font-mono text-sm p-2 mb-4" id="chat-box">
                <p class="text-green-400">NYX: Status OK. Mode: <span x-text="nyxMode"></span></p>
                <template x-for="msg in chatHistory">
                    <div class="my-1" :class="msg.role === 'user' ? 'text-blue-400' : 'text-green-400'">
                        <span x-text="msg.text"></span>
                    </div>
                </template>
            </div>
            
            <div class="flex gap-2">
                <select x-model="nyxMode" class="bg-gray-800 p-3 rounded text-white text-sm">
                    <option value="SUGGEST">SUGGEST</option>
                    <option value="APPLY">APPLY</option>
                </select>
                <input x-model="nyxInput" class="flex-1 bg-gray-800 p-3 rounded" placeholder="Command NYX... (e.g., 'Optimize schedule')" @keyup.enter="askNyx()">
                <button @click="askNyx()" class="bg-blue-600 px-4 rounded font-bold">SEND</button>
            </div>
             <a @click="view='audit'" class="text-center text-xs text-gray-500 mt-2">View Audit Log & Snapshots</a>
        </div>

        <div x-show="view === 'audit'" x-cloak>
            <h2 class="text-2xl font-bold mb-4">Audit Log & Restore</h2>
             <template x-for="log in auditLogs" :key="log.id">
                <div class="ios-card border-l-4 border-red-500">
                    <p class="text-sm font-bold" x-text="log.action"></p>
                    <p class="text-xs text-gray-400">Table: <span x-text="log.snapshot_table_name"></span> | ID: <span x-text="log.snapshot_table_id"></span></p>
                    <button @click="restoreSnapshot(log)" class="bg-red-800 text-white px-2 py-1 text-xs rounded mt-2">Restore Snapshot</button>
                </div>
            </template>
        </div>

                <div x-show="view === 'settings'" x-cloak>
            <h2 class="text-2xl font-bold mb-4">System Configuration</h2>

            <div class="ios-card bg-red-900/40 border border-red-500 mb-6" x-show="!config.jwt">
                <h3 class="font-bold mb-2 text-red-400">ðŸš¨ CRITICAL: Login Required</h3>
                <label class="text-xs text-gray-500">Email</label>
                <input x-model="auth.email" type="email" class="w-full bg-black border border-gray-700 rounded p-2 mb-2">
                <label class="text-xs text-gray-500">Password</label>
                <input x-model="auth.password" type="password" class="w-full bg-black border border-gray-700 rounded p-2 mb-4">
                
                <div class="flex gap-2">
                    <button @click="handleAuth('signup')" class="flex-1 bg-yellow-600 py-2 rounded font-bold text-sm">Sign Up (First Time)</button>
                    <button @click="handleAuth('login')" class="flex-1 bg-green-600 py-2 rounded font-bold text-sm">Log In</button>
                </div>
                <p class="text-xs text-center mt-3 text-red-300" x-text="auth.message"></p>
            </div>
            <div class="ios-card border-l-4 border-blue-500">
                <h3 class="font-bold mb-2">API Keys (CRITICAL)</h3>
                <p class="text-xs text-gray-500 mb-2" x-show="config.jwt">Logged in as: <span class="text-green-400">User ID: <span x-text="user.id"></span></span></p>
                
                <label class="text-xs text-gray-500">Supabase URL</label>
                <input x-model="config.sbUrl" class="w-full bg-black border border-gray-700 rounded p-2 mb-2">
                <label class="text-xs text-gray-500">Supabase Anon Key</label>
                <input x-model="config.sbKey" type="password" class="w-full bg-black border border-gray-700 rounded p-2 mb-4">
                <label class="text-xs text-gray-500">Backend URL (Render)</label>
                <input x-model="config.backendUrl" class="w-full bg-black border border-gray-700 rounded p-2 mb-4">
                
                <button @click="saveConfig()" class="w-full bg-blue-600 py-2 rounded font-bold">Save & Reboot</button>
            </div>
        </div>

    </main>

    <nav class="glass fixed bottom-0 w-full pb-6 pt-2 flex justify-around text-[10px] z-50">
        <div @click="view = 'dashboard'" :class="view==='dashboard'?'tab-active':'text-gray-500'" class="flex flex-col items-center">
            <i data-lucide="layout-dashboard" class="w-6 h-6 mb-1"></i> <span>Home</span>
        </div>
        <div @click="view = 'courses'" :class="view==='courses'?'tab-active':'text-gray-500'" class="flex flex-col items-center">
            <i data-lucide="book" class="w-6 h-6 mb-1"></i> <span>Codex</span>
        </div>
        <div @click="view = 'srs'" :class="view==='srs'?'tab-active':'text-gray-500'" class="flex flex-col items-center">
            <i data-lucide="repeat" class="w-6 h-6 mb-1"></i> <span>SRS</span>
        </div>
        <div @click="view = 'nyx'" :class="view==='nyx'?'tab-active':'text-gray-500'" class="flex flex-col items-center">
            <i data-lucide="bot" class="w-6 h-6 mb-1"></i> <span>Nyx</span>
        </div>
        <div @click="view = 'settings'" :class="view==='settings'?'tab-active':'text-gray-500'" class="flex flex-col items-center">
            <i data-lucide="settings" class="w-6 h-6 mb-1"></i> <span>Cfg</span>
        </div>
    </nav>

<script>
    // --- CORE APPLICATION LOGIC (Alpine.js) ---
    function app() {
        return {
                        // AUTH STATE
            auth: {
                email: '',
                password: '',
                message: 'Enter credentials and Sign Up first.',
            },

            // STATE MANAGEMENT
            view: 'dashboard',
            isPaused: false,
            nyxMode: 'SUGGEST',
            
            // Initial/Default Data
            user: { id: 'default_owner_id', active_persona: 'Senku', level: 1, xp: 0, stats: { discipline: 50, focus: 50, evolution_index: 1.0 } },
            todayKPIs: { steps: 0, study_hours: 0 },
            courses: [],
            flashcardsToReview: [],
            currentCard: null,
            cardRevealed: false,
            auditLogs: [],
            chatHistory: [],
            currentBlock: { title: 'Free Time', is_locked: false },
            currentTime: new Date().toLocaleTimeString(),
            
            // Config & API Keys
            config: {
                sbUrl: localStorage.getItem('SB_URL'),
                sbKey: localStorage.getItem('SB_KEY'),
                backendUrl: localStorage.getItem('API_URL'),
                jwt: localStorage.getItem('AUTH_JWT') // Requires Supabase Sign In to get this
            },
            supabase: null,
            kpiChartInstance: null,

            // --- INITIALIZATION ---
            initApp() {
                lucide.createIcons();
                this.updateClock(); // Start clock for scheduler view
                setInterval(() => this.updateClock(), 1000);

                if (this.config.sbUrl && this.config.sbKey) {
                    this.supabase = window.supabase.createClient(this.config.sbUrl, this.config.sbKey);
                    // AUTH FALLBACK: Force sign in/up for JWT (CRITICAL for RLS)
                    if (!this.config.jwt) {
                        this.handleAuthFallback();
                    } else {
                        this.loadInitialData();
                        this.setupChart();
                    }
                } else {
                    this.view = 'settings';
                }
            },

            handleAuthFallback() {
                // Since this is single user, we use a simple constant login
                // In a real scenario, this would trigger: await this.supabase.auth.signInWithPassword({ email, password });
                // For now, we simulate success and set a dummy JWT (will fail server-side unless user logs in via Supabase)
                // USER MUST LOGIN ON SUPABASE SITE AND MANUALLY GET JWT.
                alert("CRITICAL: Please sign in via Supabase (or set AUTH_JWT manually). Switching to Settings.");
                this.view = 'settings';
            },

            // --- DATA LOADING & SYNC ---
            async loadInitialData() {
                // 1. Fetch User Profile
                const { data: profile } = await this.supabase.from('profiles').select('*').eq('id', this.user.id).single();
                if (profile) this.user = profile;
                
                // 2. Load Courses
                const { data: courses } = await this.supabase.from('courses').select('*').eq('user_id', this.user.id);
                this.courses = courses;

                // 3. Load SRS and Filter Due Cards
                const { data: cards } = await this.supabase.from('flashcards').select('*').lt('next_review', new Date().toISOString()).eq('user_id', this.user.id);
                this.flashcardsToReview = cards;
                this.currentCard = this.flashcardsToReview[0] || null;

                // 4. Load Audit Logs (Last 10)
                const { data: logs } = await this.supabase.from('audit_logs').select('*').eq('user_id', this.user.id).order('timestamp', { ascending: false }).limit(10);
                this.auditLogs = logs;

                // 5. Check Schedule
                this.calculateCurrentBlock();
            },

            // --- OFFLINE SYNC (Robust Framework) ---
            async syncData() {
                // This function should be called on 'online' event listener
                let localChanges = await idbKeyval.get('local_changes') || [];
                if (localChanges.length === 0) return;

                alert(`Attempting to sync ${localChanges.length} local changes...`);

                try {
                    const response = await fetch(`${this.config.backendUrl}/api/sync`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${this.config.jwt}` 
                        },
                        body: JSON.stringify({ localChanges })
                    });
                    const result = await response.json();
                    
                    // Clear synced changes and reload
                    if (result.status === 'Synchronization Complete') {
                        await idbKeyval.set('local_changes', []);
                        this.loadInitialData(); // Reload server data
                    }
                    alert(`Sync finished. Conflicts ignored: ${result.results.filter(r => r.status === 'conflict_ignored').length}`);
                } catch(e) {
                    alert("Sync Error: " + e.message);
                }
            },

            // --- SCHEDULER LOGIC ---
            updateClock() {
                const now = new Date();
                this.currentTime = now.toLocaleTimeString();

                // Simple check for the hard-locked tuition block
                const hour = now.getHours();
                if (hour === 19) { // 7 PM
                    this.currentBlock = { title: 'LOCKED: Core Tuition', is_locked: true };
                } else if (hour === 20) { // 8 PM
                    this.currentBlock = { title: 'SRS Review', is_locked: false };
                } else {
                    // Complex logic to look up time_blocks table would go here
                    this.currentBlock = { title: 'Free Time / Self-Study', is_locked: false };
                }
            },
            calculateCurrentBlock() { /* Called on initial load */ this.updateClock(); },

            // --- SRS LOGIC ---
            getReviewInterval(box) {
                const intervals = [0, 1, 3, 7, 14, 30]; // Days
                return intervals[Math.min(box, 5)];
            },
            updateSRS(grade) {
                let card = this.currentCard;
                let newBox = card.box;

                if (grade === 0) newBox = 1; // Forgot -> Box 1 (1 day)
                else if (grade === 5) newBox = Math.min(card.box + 1, 5); // Perfect -> Next Box

                const days = this.getReviewInterval(newBox);
                const nextReview = new Date();
                nextReview.setDate(nextReview.getDate() + days);

                const updateData = {
                    id: card.id,
                    box: newBox,
                    review_count: card.review_count + 1,
                    next_review: nextReview.toISOString(),
                    last_modified: new Date().toISOString()
                };

                // CRITICAL: Send to Supabase and handle offline
                this.supabase.from('flashcards').upsert(updateData);
                // Offline Logic: this.saveLocalChange('flashcards', updateData);

                // Move to next card
                this.flashcardsToReview.shift();
                this.currentCard = this.flashcardsToReview[0] || null;
                this.cardRevealed = false;
            },

            // --- NYX & SCRAPING ---
            async importSyllabus() {
                 if (!this.config.backendUrl || !this.inputUrl) return;
                 // Placeholder for creating a new course ID first
                 const newCourseId = 'uuid-from-db'; 
                 
                 alert(`Attempting to scrape/import ${this.scrapeType}...`);

                 try {
                     const res = await fetch(`${this.config.backendUrl}/api/scrape`, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.jwt}` },
                         body: JSON.stringify({ url: this.inputUrl, type: this.scrapeType, courseId: newCourseId })
                     });
                     const data = await res.json();
                     if (data.error) throw new Error(data.error);
                     alert(data.message);
                     this.loadInitialData(); // Refresh list
                 } catch(e) { alert("Import Failed: " + e.message); }
            },

            async askNyx() {
                if (!this.config.backendUrl || !this.nyxInput) return;
                
                const context = {
                    userId: this.user.id,
                    persona: this.user.active_persona,
                    stats: this.user.stats
                };

                try {
                    const res = await fetch(`${this.config.backendUrl}/api/nyx/think`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.jwt}` },
                        body: JSON.stringify({ 
                            prompt: this.nyxInput, 
                            context, 
                            mode: this.nyxMode, 
                            target_table: 'time_blocks', // Example table target
                            target_id: 'N/A'
                        })
                    });
                    const data = await res.json();
                    
                    this.chatHistory.push({role: 'user', text: this.nyxInput});
                    this.chatHistory.push({role: 'nyx', text: JSON.stringify(data.result, null, 2)});
                    this.nyxInput = '';

                    // Reload logs/data if a change was executed
                    if (data.executed) { this.loadInitialData(); }
                    
                } catch(e) { alert("NYX Connection Error: " + e.message); }
            },
            
            // --- AUDIT & RESTORE LOGIC ---
            async restoreSnapshot(log) {
                if (!log.snapshot_before || log.snapshot_table_name === 'N/A') return alert("Cannot restore: No snapshot data found.");
                
                try {
                    const snapshotData = log.snapshot_before;
                    const table = log.snapshot_table_name;

                    // The snapshot should contain the *old* data, so we insert it back.
                    const { error } = await this.supabase
                        .from(table)
                        .upsert(snapshotData, { onConflict: 'id' }); // Revert using UPSERT

                    if (error) throw new Error(error.message);

                    // Log the restoration action itself
                    await this.supabase.from('audit_logs').insert({
                        user_id: this.user.id,
                        action: 'MANUAL_RESTORE',
                        ai_reasoning: `Reverted ${table} ID ${log.snapshot_table_id} using log ${log.id}`,
                        snapshot_before: log.snapshot_before,
                    });
                    
                    alert(`Restored ${table} to previous state.`);
                    this.loadInitialData(); // Refresh UI
                } catch(e) {
                    alert("RESTORE FAILED: " + e.message);
                }
            },
            
            // --- GAMIFICATION & KPIs ---
            setupChart() {
                const dataPoints = [this.user.stats.focus, this.user.stats.coldness, 80, this.user.stats.discipline, this.todayKPIs.study_hours];
                const labels = ['Focus', 'Coldness', 'Observation', 'Discipline', 'Study Hours'];
                
                const ctx = document.getElementById('kpiChart').getContext('2d');
                if (this.kpiChartInstance) { this.kpiChartInstance.destroy(); }

                this.kpiChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Trait Levels',
                            data: dataPoints,
                            borderColor: 'rgba(10, 132, 255, 1)',
                            backgroundColor: 'rgba(10, 132, 255, 0.2)',
                            pointBackgroundColor: 'rgba(10, 132, 255, 1)'
                        }]
                    },
                    options: { 
                        responsive: true,
                        scales: { r: { grid: { color: '#444' }, ticks: { display: false }, angleLines: { color: '#444' }, pointLabels: { color: 'white' } } }
                    }
                });
            },
            syncKPIs() {
                // When manual input changes (like steps), sync to kpi_stats table
                // this.supabase.from('kpi_stats').upsert({ date: new Date().toISOString().split('T')[0], steps: this.todayKPIs.steps, user_id: this.user.id });
                // Note: Evolution Index calculation (complex) happens on the server via DB trigger/function
            },
            
            // --- CONFIGURATION ---
            saveConfig() {
                localStorage.setItem('SB_URL', this.config.sbUrl);
                localStorage.setItem('SB_KEY', this.config.sbKey);
                localStorage.setItem('API_URL', this.config.backendUrl);
                alert("System Rebooting. Please reload the PWA from your Home Screen.");
            },
                        // --- AUTHENTICATION LOGIC ---
            async handleAuth(mode) {
                this.auth.message = 'Processing...';
                if (!this.config.sbUrl || !this.config.sbKey) {
                    this.auth.message = 'Error: Enter Supabase Keys first!';
                    return;
                }
                
                // Ensure Supabase client is initialized before authentication
                this.supabase = window.supabase.createClient(this.config.sbUrl, this.config.sbKey);

                let response;
                try {
                    if (mode === 'signup') {
                        response = await this.supabase.auth.signUp({
                            email: this.auth.email,
                            password: this.auth.password,
                        });
                    } else if (mode === 'login') {
                        response = await this.supabase.auth.signInWithPassword({
                            email: this.auth.email,
                            password: this.auth.password,
                        });
                    }
                    
                    if (response.error) {
                        throw new Error(response.error.message);
                    }

                    if (response.data.session) {
                        const jwt = response.data.session.access_token;
                        localStorage.setItem('AUTH_JWT', jwt);
                        this.config.jwt = jwt; // Update the config state
                        this.user.id = response.data.user.id; // Set user ID
                        this.auth.message = `Success! Logged in. Tap Save & Reboot.`;
                        alert("Authentication successful! Tap 'Save & Reboot' now.");
                    } else if (mode === 'signup') {
                         this.auth.message = 'Sign Up successful! Check your email to confirm, then Log In.';
                    }

                } catch (e) {
                    this.auth.message = `Auth Failed: ${e.message}`;
                    console.error('Auth Error:', e);
                }
            },


            // --- OFFLINE HELPER ---
            saveLocalChange(table, data) {
                // Placeholder for saving to IndexedDB before sending to /api/sync
                // let changes = idbKeyval.get('local_changes') || [];
                // changes.push({ table, data, timestamp: new Date().toISOString() });
                // idbKeyval.set('local_changes', changes);
            }
        }
    }
</script>
</body>
</html>
